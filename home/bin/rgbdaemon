#!/usr/bin/bash

setcolor_base() {
    echo "rgb $1" > $keyboard
    echo "rgb $1" > $mouse

    accents_kb="h,j,k,l,w,a,s,d,m3,g11,profswitch"
    echo "rgb $accents_kb:$2" > $keyboard
    accents_mouse="wheel,thumb"
    echo "rgb $accents_mouse:$2" > $mouse
}
setcolor_player() {
    echo "rgb play:$1" > $keyboard
}
setcolor_workspace() {
    echo "rgb $2:$1" > $keyboard
}
setcolor_print() {
    echo "rgb prtscn:$1" > $keyboard
}
setcolor_lock() {
    echo "rgb lock:$1" > $keyboard
}
setcolor_tty() {
    echo "rgb f$1:$2" > $keyboard
}
setcolor_bw() {
    echo "rgb scroll:$1" > $keyboard
}
setcolor_mute() {
    echo "rgb mute:$1" > $keyboard
}
setcolor_light() {
    echo "rgb light:$1" > $keyboard
}

daemon_dark() {
    if /home/misterio/bin/isdark; then
        setcolor_light $2
    else
        setcolor_light $1
    fi
}
daemon_mute() {
    if [[ $(pulseaudio-ctl full-status | awk '{print $2}') == "yes" ]]; then
        setcolor_mute $1
    else
        setcolor_mute $2
    fi
}
daemon_bw() {
    if [[ -f /tmp/bwtoken ]]; then
        setcolor_bw $1
    else
        setcolor_bw $2
    fi
}
daemon_tty() {
    for n in 1 2 3 4 5 6; do
        if ttystatus=$(ps -e | grep tty$n) && ! echo $ttystatus | grep "agetty"; then
            setcolor_tty $n $1
        else
            setcolor_tty $n $2
        fi
    done
}

daemon_workspaces() {
    # Workspace Colors
    declare -a workspaces=()
    while read line; do
        info=$(echo $line | cut -d '"' -f2)
        num=$(echo $info | cut -d ':' -f1)
        if [ "$num" = "10" ]; then
            num="0"
        fi

        if [ "$(echo $info | cut -d ':' -f2)" = "true" ]; then
            workspaces[$num]=$1
       elif [ "$(echo $info | cut -d ':' -f3)" = "true" ]; then
            workspaces[$num]=$2
        elif [ "$(echo $info | cut -d ':' -f4)" = "true" ]; then
            workspaces[$num]=$3
        else
            workspaces[$num]=$4
        fi
    done <<<$(i3-msg -t get_workspaces | jq '.[] | @sh "\(.num):\(.urgent):\(.focused):\(.visible)"' | tr " " "\n")
    for num in $(seq 0 9); do
        color=${workspaces[$num]}
        if [ -z "$color" ]; then
            color=$5
        fi
        setcolor_workspace $color $num
    done
}
daemon_player() {
    # Playing color
    status=$(mpris-ctl status 2>/dev/null)
    if [[ $status == "Playing" ]]; then
        setcolor_player $1
    elif [[ $status == "Paused" ]]; then
        setcolor_player $2
    else
        setcolor_player $3
    fi
}
daemon_print() {
    if pgrep -x slurp > /dev/null; then
        setcolor_print $1
    else
        setcolor_print $2
    fi
}
daemon_lock() {
    if pgrep -x swaylock > /dev/null; then
        setcolor_lock $1
    elif pgrep -x swaylock-blur > /dev/null; then
        setcolor_lock $2
    else
        setcolor_lock $3
    fi
}
bindings() {
    echo "bind profswitch:f13" > $keyboard
    echo "bind lock:f14" > $keyboard
    echo "bind light:f15" > $keyboard
}

if ! pgrep -x ckb-next-daemon > /dev/null; then
    echo "Error: Ckb-next is not running" >&2
    exit -1
fi
if ! pgrep -x openrgb > /dev/null; then
    echo "Error: OpenRGB is not running" >&2
    exit -2
fi

source ~/.colors
color_base=$(pastel mix $base00 $base05 | pastel darken 0.1 | pastel saturate 0.5 | pastel format hex | cut -d '#' -f2)
color_trim=$(pastel darken 0.1 $base0B | pastel saturate 0.8 | pastel format hex | cut -d '#' -f2)

color_urgent=$(pastel saturate 0.6 $base09 | pastel format hex | cut -d '#' -f2)
color_visible=$(pastel saturate 0.1 $base0F | pastel format hex | cut -d '#' -f2)
color_unfocused=$(pastel lighten 0.1 $base05 | pastel format hex | cut -d '#' -f2)

(openrgb --client; openrgb --client --device=0 --color $color_base --mode static) & \

keyboard="/dev/input/ckb1/cmd"
mouse="/dev/input/ckb2/cmd"
echo active > $keyboard
echo active > $mouse
bindings

setcolor_base $color_base $color_trim & \
while true; do
    #daemon_workspaces $color_urgent $color_trim $color_visible $color_unfocused $color_base & \
    daemon_mute "000000" $color_base & \
    daemon_bw $color_trim $color_visible & \
    daemon_tty $color_trim $color_base & \
    daemon_lock $color_trim "000000" $color_base & \
    daemon_dark $color_visible $color_trim & \
    daemon_player $color_trim $color_visible $color_base & \
    daemon_print $color_trim $color_base
    sleep 0.4
done
