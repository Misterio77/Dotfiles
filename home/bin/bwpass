#!/usr/bin/zsh
source /tmp/bwtoken

if ! [ -f /tmp/bwtoken ]; then
    notify-send "Error" "Your vault is locked" -t 4000
    exit -2
fi

startingquery=""
# Check if focused app is qutebrowser
if swaymsg -t get_tree | grep "\"focused\": true" -B 10 | grep "qutebrowser" -q; then
    qutebrowser :yank
    startingquery=$(wl-paste | cut -d '/' -f3 | sed s/"www."//)
fi

if [ -n "$2" ]; then
	query=$2
else
    query=$(zenity --entry --text="Account/site to search on bitwarden" --entry-text=$startingquery) || exit -1
fi

if [ -n "$1" ]; then
	field=$1
else
	field=$(zenity --entry --text="Field to search on bitwarden" --entry-text="password") || exit -1
fi


result=$(bw get $field $query --nointeraction)
if [ $(echo $?) -eq 0 ]; then
    if ! systemctl --user is-active --quiet screencast.service; then
        notify-send "$field for $query:" "$result" -t 4000
        echo $result
    else
        notify-send "$field for $query:" "<hidden>" -t 4000
        echo $result
    fi
else
    notify-send "Error" "Couldn't find $field for $query" -t 4000
    exit -1
fi


